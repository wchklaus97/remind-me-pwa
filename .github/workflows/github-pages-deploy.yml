name: Build and Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-branches"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    # head_commit only exists on push events; for PRs we always run
    if: github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip ci]')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: Cache dependencies
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            # Note: We exclude target/ from cache to ensure base_path changes take effect
            # target/ contains build artifacts that depend on Dioxus.toml configuration
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install cargo-binstall
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Dioxus CLI
        run: |
          if ! command -v dx &> /dev/null; then
            # Use dioxus-cli 0.7.x to match dioxus crate version 0.7
            # Version mismatch causes asset! macro to fail with placeholder error message
            cargo binstall dioxus-cli --version 0.7.0 --no-confirm 2>&1 || \
            cargo install dioxus-cli --version 0.7.0 --locked --jobs "$(nproc)"
          fi
          dx --version

      - name: Install binaryen (wasm-opt)
        run: |
          sudo apt-get update
          sudo apt-get install -y binaryen
          wasm-opt --version
          echo "âœ… binaryen (wasm-opt) installed"

      - name: Configure base_path for GitHub Pages
        env:
          # Set this environment variable to configure base_path for GitHub Pages
          # If not set, base_path will remain empty (for local development)
          GITHUB_PAGES_BASE_PATH: "/remind-me-pwa"
        run: |
          # Clean any previous build artifacts to ensure base_path change takes effect
          # This is important because cached target/ might contain old builds with wrong base_path
          if [ -d "target" ]; then
            echo "ðŸ§¹ Cleaning target/ directory to ensure fresh build with correct base_path..."
            rm -rf target/dx/*/release/web/public 2>/dev/null || true
            rm -rf target/dx/*/wasm-release/web/public 2>/dev/null || true
            echo "âœ… Cleaned build output directories"
          fi
          
          if [ -n "$GITHUB_PAGES_BASE_PATH" ]; then
            # Update base_path in Dioxus.toml using the environment variable
            sed -i "s|base_path = \".*\"|base_path = \"$GITHUB_PAGES_BASE_PATH\"|" Dioxus.toml
            echo "âœ… Updated base_path to: $GITHUB_PAGES_BASE_PATH"
            echo "   Dioxus will automatically prepend this to all asset URLs"
          else
            echo "â„¹ï¸  GITHUB_PAGES_BASE_PATH not set, using default base_path from Dioxus.toml"
          fi
          # Verify the change
          echo "ðŸ“‹ Current base_path in Dioxus.toml:"
          grep "base_path" Dioxus.toml || echo "   (not found)"

      - name: Build web pages
        run: |
          set -o pipefail
          export CARGO_BUILD_JOBS="$(nproc)"
          export CARGO_NET_GIT_FETCH_WITH_CLI=true
          export CARGO_NET_RETRY=3

          echo "Building with ${CARGO_BUILD_JOBS} parallel jobs..."
          echo "Rust: $(rustc --version)"
          echo "dx: $(dx --version || true)"
          echo "wasm32 target: $(rustup target list --installed | grep wasm32 || echo 'not installed')"

          # NOTE: In CI, dx can sometimes exit non-zero with:
          # "Cargo build failed - no output location" / "Build did not return an executable"
          # while still producing the static output directory. So we:
          # - capture the exit code
          # - proceed if output exists
          set +e
          # Build for production
          # Note: debug symbols are enabled in Cargo.toml (wasm-release profile)
          # This is REQUIRED for Dioxus asset! macro to work correctly
          dx build --release --platform web 2>&1 | tee build.log
          DX_EXIT="${PIPESTATUS[0]}"
          set -e
          echo "dx exit code: ${DX_EXIT}"
          
          # Find and copy build output
          # Use globbing so we don't depend on the exact app folder name
          OUTPUT_DIR=""
          OUTPUT_DIR="$(ls -d target/dx/*/release/web/public 2>/dev/null | head -1 || true)"
          if [ -z "$OUTPUT_DIR" ]; then
            OUTPUT_DIR="$(ls -d target/dx/*/wasm-release/web/public 2>/dev/null | head -1 || true)"
          fi
          if [ -z "$OUTPUT_DIR" ]; then
            OUTPUT_DIR="$(ls -d target/dx/*/debug/web/public 2>/dev/null | head -1 || true)"
          fi
          
          if [ -n "$OUTPUT_DIR" ] && [ -d "$OUTPUT_DIR" ]; then
            echo "âœ… Found build output at: $OUTPUT_DIR"
            mkdir -p dist
            cp -r "$OUTPUT_DIR"/* dist/
            echo "âœ… Files copied to dist/"
          else
            echo "âŒ Error: Build output not found"
            echo "---- dx build.log (last 80 lines) ----"
            tail -80 build.log || true
            echo "--------------------------------------"
            find target -name "*.html" -o -name "*.wasm" 2>/dev/null | head -10
            exit 1
          fi

      - name: Prepare deployment
        run: |
          # Move files if needed
          if [ -d "dist/public" ]; then
            mv dist/public/* dist/
            rmdir dist/public
          fi
          
          # LCP Optimization: Optimize WASM bundle with wasm-opt
          # This reduces WASM file size by 10-30% and improves loading performance
          # Note: If wasm-opt fails, we continue with unoptimized WASM (non-critical optimization)
          # IMPORTANT: Do NOT use --strip-debug as it removes symbols needed by Dioxus asset! macro
          # The error message "This should be replaced by dx..." appears when symbols are stripped
          if command -v wasm-opt &> /dev/null; then
            echo "ðŸ”§ Optimizing WASM bundle with wasm-opt for better LCP..."
            find dist -name "*.wasm" -type f | while read wasm_file; do
              echo "  Optimizing: $(basename "$wasm_file")"
              # Use -Oz for maximum size optimization but WITHOUT --strip-debug
              # --strip-debug removes symbols that Dioxus asset! macro needs to resolve asset paths
              if wasm-opt "$wasm_file" -o "$wasm_file.tmp" -Oz 2>&1; then
                mv "$wasm_file.tmp" "$wasm_file"
                echo "    âœ… Optimized successfully"
              else
                echo "    âš ï¸  Optimization failed, using original file"
                rm -f "$wasm_file.tmp"
              fi
            done
            echo "âœ… WASM optimization complete"
          else
            echo "âš ï¸  wasm-opt not found, skipping WASM optimization"
          fi
          
          # Create 404.html for client-side routing
          if [ -f "dist/index.html" ]; then
            cp dist/index.html dist/404.html
            echo "âœ… Created 404.html"
          fi
          
          # Copy robots.txt and sitemap.xml to root (SEO: must be at site root, not in assets/)
          if [ -f "assets/robots.txt" ]; then
            cp assets/robots.txt dist/robots.txt
            echo "âœ… Copied robots.txt to root"
          fi
          if [ -f "assets/sitemap.xml" ]; then
            cp assets/sitemap.xml dist/sitemap.xml
            echo "âœ… Copied sitemap.xml to root"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  deploy-gh-pages:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy: ${{ github.event.head_commit.message || github.sha }}'

  deploy-release-branch:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create or update release branch
        run: |
          # Check if release branch exists remotely
          if git ls-remote --heads origin release | grep -q release; then
            echo "Release branch exists, fetching..."
            git fetch origin release:release || true
            git checkout release
            # Remove all existing files except .git
            git rm -rf . 2>/dev/null || find . -mindepth 1 ! -name '.git' -exec rm -rf {} + || true
          else
            echo "Release branch doesn't exist, creating orphan branch..."
            git checkout --orphan release
            git rm -rf . 2>/dev/null || true
          fi
          
          # Copy dist contents to root
          cp -r dist/* . 2>/dev/null || true
          rm -rf dist
          
          # Create commit
          git add -A
          if ! git diff --staged --quiet; then
            COMMIT_MSG="Release: ${{ github.event.head_commit.message || github.sha }}"
            COMMIT_MSG="${COMMIT_MSG}"$'\n'$'\n'"Built from: ${{ github.sha }}"
            COMMIT_MSG="${COMMIT_MSG}"$'\n'"Build date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git commit -m "$COMMIT_MSG"
            git push origin release --force
            echo "âœ… Release branch updated"
          else
            echo "No changes to commit in release branch"
          fi

